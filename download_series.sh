#!/bin/sh

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä
if [ $# -ne 1 ]; then
    echo "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: $0 <—à–ª—è—Ö_–¥–æ_json_—Ñ–∞–π–ª—É>"
    exit 1
fi

# –ü—Ä–∏–∑–Ω–∞—á–∞—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä —è–∫ –≤—Ö—ñ–¥–Ω–∏–π —Ñ–∞–π–ª
input_file="$1"


# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó —è–∫—â–æ —ó—ó –Ω–µ–º–∞—î
create_dir() {
    local path="$1"
    local dir=$(dirname "$path")
    if [ ! -d "$dir" ]; then
        mkdir -p "$dir"
    fi
}

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ñ–∞–π–ª —ñ—Å–Ω—É—î
if [ ! -f "$input_file" ]; then
    echo "–ü–æ–º–∏–ª–∫–∞: —Ñ–∞–π–ª $input_file –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
    exit 1
fi

# –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –∫–æ–∂–Ω–æ–º—É –æ–±'—î–∫—Ç—É –≤ –º–∞—Å–∏–≤—ñ
jq -c '.[]' "$input_file" | while read -r item; do
  {
     # –û—Ç—Ä–∏–º—É—î–º–æ path —Ç–∞ link
        path=$(echo "$item" | jq -r '.path')
        link=$(echo "$item" | jq -r '.link')

        # echo "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: $path"

        # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
        create_dir "$path"

        link="https://rezka.fayvlad.workers.dev/?target=$link"
        # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–∞–π–ª
        wget -q -O "$path" "$link" || {
            echo "üö´–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ $path"
            continue
        }

        echo "‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: $path"
  } || {
    echo "‚ö†Ô∏è –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –µ–ª–µ–º–µ–Ω—Ç–∞: $item"
    continue
  }

done

echo "üöÄ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
