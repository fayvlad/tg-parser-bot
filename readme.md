# tg-parser-bot

Telegram‑бот для отримання, парсингу та нормалізації лінків на фільми й серіали з різних джерел.

Це pet‑project, який реалізує модульну архітектуру провайдерів — кожен провайдер інкапсулює парсинг конкретного сайту. README описує, як запускати проєкт, як додавати нові провайдери та основні принципи роботи.

---

## Ключові можливості

- Прийом URL від користувача через Telegram.
- Парсинг сторінок різних джерел (провайдери).
- Підтримка стрім‑лінків та m3u‑плейлистів.
- Завантаження або експорт посилань у JSON / m3u.
- Розширювана архітектура: додаєте нові провайдери — бот вміє їх оброблювати.

---

## Архітектура

Коротко:

- `index.js` — точка входу (Telegram‑логіка).
- `providers/` — каталог провайдерів (кожен провайдер — окремий модуль).
- `provider.base.js` — базовий абстрактний провайдер (спільна логіка).
- `url-parser.js` — валідація/нормалізація вхідних URL.
- `m3u-manager.js` — робота з m3u / додавання стрімів у плейлист.
- `step-enum-util.js` — enum зі станами (кроки обробки).

Файлова структура проекту (спрощено):

```
.
├── providers/
│   ├── provider.base.js
│   ├── rezka.ag.js
│   ├── uakino.club.js
│   └── ...
├── index.js
├── url-parser.js
├── m3u-manager.js
├── step-enum-util.js
├── package.json
└── readme.md
```

---

## Вимоги

- Node.js >= 18 (рекомендовано)
- npm або yarn
- Telegram Bot Token

---

## Установка

1. Клонувати репозиторій:

```bash
git clone <your-repo-url>
cd tv_bot
```

2. Встановити залежності:

```bash
npm install
# або
# yarn install
```

3. Створити `.env` в корені проєкту і додати змінні:

```env
BOT_TOKEN=your_telegram_bot_token
# додаткові змінні провайдерів, якщо потрібно
# REZKA_LOGIN=...
# REZKA_PASSWORD=...
```

> Не комітьте `.env` у репозиторій.

---

## Запуск

Просто запустіть бот:

```bash
node index.js
```

Після запуску бот підключається до Telegram і готовий приймати повідомлення.

---

## Використання

Надішліть боту лінк на фільм/серіал — бот спробує знайти провайдера, який зможе опрацювати лінк, і запустить відповідну логіку:

1. Завантажить сторінку (через базовий провайдер або специфічну реалізацію).
2. Збере доступні переклади/сезони/серії.
3. Поверне посилання на потокове відео або збере JSON/m3u для завантаження.

Кнопки й меню — кроки реалізовані через `step-enum-util.js`.

---

## Провайдери

Кожен провайдер — окремий файл у `providers/`. Тепер у проєкті є `provider.base.js` — базовий клас, який містить загальні методи (завантаження сторінки, парсинг meta, підготовка m3u тощо). Провайдери наслідуються від бази і реалізують лише специфічну логіку.

Шаблон простого провайдера (приклад, мінімум для сумісності):

```js
const ProviderBase = require("./provider.base");

class Worker extends ProviderBase {
  constructor(link) {
    super(link);
    this.pageLink = link;
  }

  // повертає Observable або інший очікуваний тип для loadPage
  loadPage() {
    // реалізація специфічного парсингу
  }

  // повинен повертати масив Observables або інші посилання
  getLinks() {
    return [];
  }
}

module.exports = Worker;
```

Поради при додаванні провайдера:

- Повторно використовуйте методи `ProviderBase` (getHtml/getJson/parseMetaTag).
- Тримайте специфіку парсингу в одному файлі.
- Тестуйте провайдер на декількох сторінках сайту (різні сезони/серії).

---

## Тестування / Smoke checks

Проєкт не містить повних unit‑тестів за замовчуванням. Рекомендую додати кілька смоук‑тестів:

- Скрипт, що створює екземпляр кожного провайдера з тестовим лінком і викликає `loadPage()`.
- Мок‑fetch для стабільних тестів без зовнішніх залежностей.

Можливий простий скрипт для ручної перевірки (`test/run-providers.js`):

```js
// простий приклад: require провайдери і викликати loadPage
const providers = [
  require("../providers/rezka.ag"),
  require("../providers/uakino.club"),
];

(async () => {
  for (const P of providers) {
    const inst = new P("https://example.com/some");
    try {
      const step = await inst.loadPage().toPromise();
      console.log("OK", P.name, step);
    } catch (e) {
      console.error("ERR", P.name, e.message);
    }
  }
})();
```

---

## Налагодження / Troubleshooting

- Якщо бот не відповідає — перевірте `BOT_TOKEN` в `.env`.
- Якщо провайдер не знаходить посилання — відкрийте сторінку в браузері і перевірте структуру HTML (іноді сайти змінюють розмітку).
- Логи помилок пишуться до консолі — додайте більш детальне логування там, де потрібно (в провайдерах).

---

## Безпека

- Зберігайте токени тільки в `.env`.
- Не логируйте приватні дані користувачів у продакшн.
- Обмежуйте кількість зовнішніх запитів (rate limiting) для кожного провайдера.

---

## Внесок

Якщо хочете допомогти:

1. Створіть форк.
2. Додайте провайдер або виправлення.
3. Відправте Pull Request з коротким описом.

---

## License

MIT — див. файл LICENSE (або додайте, якщо потрібно).

---

Якщо хочете, можу також:

- Додати приклади unit‑тестів (Jest) і базовий runner для smoke‑перевірок.
- Автоматично створити `test/run-providers.js` і запустити його тут (потрібні тестові URL або мокі).

Напишіть, хочете перевіряти провайдери реальними URL або створити мок‑шаблон для тестів — я зроблю наступний крок.
